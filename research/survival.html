---
layout: stats
title: "Overlevelse"
---

<h1>Overlevelsesanalyse</h1>
<p>Overlevelsesmodeller (eller survival-modeller) er intensitetsbaserede modeller hvor udfaldet måles i hvor lang tid der går indtil et binomialt event. 
</p>

<h2>Datastruktur</h2>
<p>Modellerne skal bruge tre variable:<br>
1) En <b>event-variable</b>, der angiver om hændelsen er indtruffet eller ej. Variablen skal være <i>logical</i> (TRUE/FALSE) når den indgår - men det nemmeste er at kode variablen som enten <i>factor</i> eller <i>integer</i> med to niveauer, som derefter omformateres i modellen som <code>variable == reference</code>;<br>
2) En <b>tidsvariable</b>, der angiver tiden fra start til enten forekomsten af eventet eller til frafald. Variablen kan enten være <i>numeric</i> eller <i>interger</i>.<br>
Hvis udfaldet er dødsfald efter inklusion i studiet vil variablen angive tiden indtil at deltageren enten dør eller frafalder studiet; hvis deltageren dør kodes event-variablen som fx: TRUE (logical), 1 (numical/integer), "Dead" (factor) og hvis deltageren frafalder som fx: FALSE (logical), 0 (numical/integer), "Alive" (factor). Hvis deltageren overlever indtil afslutningen af opfølgningen kodes variablen på samme måde som ved frafald, men med tiden for sidste opfølgning;<br>  
3) En <b>eksponeringsvariabel</b> som både kan være kvantitativ (<i>numeric</i>/<i>integer</i>) og kategorisk (<i>factor</i>).<br><br>
Grundformlen for modellen bliver således: <br>
<center><code><b>surv</b>(<i>tidsvariabel</i>, <i>event-variabel</i> == <i>reference-værdi</i>) ~ <i>eksponering</i></code></center><br><br>
Yderligere kan modellen justeres for kovariate ved at tilføje dem på højre side af formlen:<br><br>
<center><code><b>surv</b>(<i>tidsvariabel</i>, <i>event-variabel</i> == <i>reference-værdi</i>) ~ <i>eksponering</i> + <i>kovariate</i></code></center><br><br>
</p>
<p><i>Eksempel</i><br>
Som eksempel bruges data fra et kohortestudie med 1031 patienter med apopleksi, der er fulgt i et år efter de blev indlagt. Udfaldet er tid indtil dødsfald og som eksempel bruges en variabel med to subtyper IS (ischemic stroke) og ICH (intracerebral heamorrhage):</p>
<p class="rcode">strokedata <- read.csv("<a href="https://jacobliljehult.github.io/research/strokedata.csv" >https://jacobliljehult.github.io/research/strokedata.csv</a>",
             sep=",", header=T, stringsAsFactors = TRUE)
</p>
<p class="rcode">
library(dplyr)<br>
rbind(<br>
&emsp; strokedata %>% <br>
&emsp; &emsp; select(daystillmors, morsdic1y, diagdict) %>% <br>
&emsp; &emsp; arrange(daystillmors) %>% <br>
&emsp; &emsp; filter(row_number() &lt;= 5, row_number() &gt;= 1),<br>
&emsp; strokedata %>% <br>
&emsp; &emsp; select(daystillmors, morsdic1y, diagdict) %>% <br>
&emsp; &emsp; arrange(-daystillmors) %>% <br>
&emsp; &emsp; filter(row_number() &lt;= 5, row_number() &gt;= 1))
    </p>
<div class="routput">
<table>
<tr><th></th><th>daystillmors</th><th>morsdic1y</th><th>diagdict</th></tr>
<tr><th>1</th><th>0</th><th>Dead</th><th>ICH</th></tr>
<tr><th>2</th><th>0</th><th>Alive</th><th>ICH</th></tr>
<tr><th>3</th><th>0</th><th>Dead </th><th>ICH</th></tr>
<tr><th>4</th><th>0</th><th>Dead</th><th>ICH</th></tr>
<tr><th>5</th><th>0</th><th>Dead</th><th>IS</th></tr>
<tr><th>6</th><th>1597</th><th>Alive</th><th>IS</th></tr>
<tr><th>7</th><th>1595</th><th>Alive</th><th>IS</th></tr>
<tr><th>8</th><th>1595</th><th>Alive</th><th>IS</th></tr>
<tr><th>9</th><th>1595</th><th>Alive</th><th>IS</th></tr>
<tr><th>10</th><th>1595</th><th>Alive</th><th>IS</th></tr>
</table>
</div>
<p>De tre variable indeholder følgende information:<br> <br>
<b>daystillmors</b> - antallet af dage til dødsfald (eller frafald) indtil 1595 dage efter indlæggelsestidspunktet; <br>
<b>morsdic1y</b> - dichotom factor-variabel der angiver om patienten er død eller levende et år efter indlæggelsesdagen; og <br>
<b>diagdict</b> - factor-variabel der angiver subtypen dichotomt som enten IS eller ICH</p><br>


<h2>Cox' Proportional Hazard regression</h2>
<p>Proportional hazard regression kan laves med funktionen <b>coxph</b>() fra pakken {survival} med syntaksen: <b>coxph</b>( <b><i>Surv</i></b>( <i>t</i>, <i>e</i> == <i>r</i>) ~ <i>x</i>, data = <i>df</i>).<br>
Resultatet af modellen vises med funktionen <b>summary</b>().</p>
<p class="rcode">library(survival) <br>
model1 &lt;- coxph(Surv(daystillmors, morsdic1y == "Dead") ~ diagdict,<br>
&emsp; &emsp; &emsp; &emsp; data = strokedata) <br>
summary(model1)  </p>
<div class="routput">
Call:<br>
coxph(formula = Surv(daystillmors, morsdic1y == "Dead") ~ diagdict, data = strokedata)<br><br>
  n = 1031, number of events= 186 <br><br>
<table>
<tr><th></th><th>coef</th><th>exp(coef)</th><th>se(coef)</th><th>z</th><th>Pr(>|z|)</th><th></th></tr>
<tr><th>diagdictIS</th><th>-1.0522</th><th>0.3492</th><th>0.1770</th><th>-5.945</th><th>2.76e-09</th><th>***</th></tr>
</table>
---<br>
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1<br><br>
<table>
<tr><th></th><th> exp(coef)</th><th>exp(-coef)</th><th>lower .95</th><th>upper .95</th></tr>
<tr><th>diagdictIS</th><th>    0.3492</th><th>2.864</th><th>0.2468</th><th>0.494</th></tr>
</table><br>
Concordance = 0.567  (se = 0.015 )<br><br>
<table>
<tr><th style="text-align:left;">Likelihood ratio test</th><th>= 28.65</th><th>on 1 df,</th><th>p=9e-08</th></tr>
<tr><th style="text-align:left;">Wald test            </th><th>= 35.35</th><th>on 1 df,</th><th>p=3e-09</th></tr>
<tr><th style="text-align:left;">Score (logrank) test </th><th>= 38.73</th><th>on 1 df,</th><th>p=5e-10</th></tr>
</table>
</div>
<p>Outputtet fra <b>summary</b>() funktionen indeholder både koefficienten på eksponentiel skala  (<code>coef</code>) og hazard ratio (<code>exp(coef)</code>), samt konfidensintervallet for hazard ratioen, men kan være lidt svær at overskue. Et lidt mere overskueligt output kan man få med <b>publish</b>() funktionen fra pakken {Publish}:</p>
<p class="rcode">
Publish::publish(model1)
</p>
<div class="routput"><table>
<tr><th>Variable</th><th>Units</th><th>HazardRatio</th><th>       CI.95</th><th> p-value </th></tr> 
<tr><th>diagdict</th><th>ICH</th><th>         Ref</th><th> </th><th>                    </th></tr> 
<tr><th></th><th>IS</th><th>        0.35</th><th> [0.25;0.49]</th><th>&lt;0.001</th></tr>  
</table></div>
<p>Referenceværdien for eksponeringsvariablen kan ændres med funktionen <b>relevel</b>():</p>
<p class="rcode">
model2 &lt;- coxph(Surv(daystillmors, morsdic1y == "Dead") ~ <br>&emsp; &emsp; &emsp; &emsp; &emsp; &emsp;  relevel(diagdict, ref="IS"), 
data = strokedata)  <br>
Publish::publish(model2)
</p>
<div class="routput"><table>
<tr><th>Variable</th><th>Units</th><th>HazardRatio</th><th>CI.95</th><th>p-value</th></tr> 
<tr><th>relevel(diagdict, ref = "IS")</th><th>IS</th><th>Ref</th><th>        </th><th></th></tr>             
<tr><th>                             </th><th>ICH</th><th>2.86</th><th>[2.02;4.05]</th><th>&lt;0.001</th></tr> 
</table></div>
<p>Modellen kan justeres for en kovariate ved at forbinde dem med <i>x</i>-variablen på højre side af formlen:</p> 
<p class="rcode">
model3 &lt;- coxph(Surv(daystillmors, morsdic1y == "Dead") ~ <br>&emsp; &emsp; &emsp; &emsp; &emsp; &emsp;  relevel(diagdict, ref="IS") + age,
data = strokedata)<br>
Publish::publish(model3)
</p>
<div class="routput"><table>
<tr><th>Variable</th><th>Units</th><th>HazardRatio</th><th>       CI.95</th><th> p-value </th></tr> 
<tr><th>relevel(diagdict, ref = "IS")</th><th>IS</th><th>         Ref</th><th> </th><th>                    </th></tr> 
<tr><th></th><th>ICH</th><th>        2.83</th><th> [2.00;4.01]</th><th>&lt;0.001</th></tr>
<tr><th>age</th><th></th><th>        1.10</th><th> [1.08;1.12]</th><th>&lt;0.001</th></tr>
</table></div>

<h2>Log-rank test</h2>
<p>Log-rank test kan laves med funktionen <b>survdiff</b>() fra pakken {survival}:</p>
<p class="rcode">library(survival) <br>
survdiff(Surv(daystillmors, morsdic1y == "Dead") ~ relevel(diagdict, ref="IS"), <br>
&emsp; &emsp; &emsp; data = strokedata) 
</p>
<div class="routput">
Call:<br>
survdiff(formula = Surv(daystillmors, morsdic1y == "Dead") ~ <br>
&emsp; &emsp;     relevel(diagdict, ref = "IS"), data = strokedata)<br><br>

<table>
<tr><th>                                </th><th>  N</th><th>Observed</th><th>Expected</th><th>(O-E)^2/E</th><th>(O-E)^2/V</th></tr> 
<tr><th style="text-align:left;">relevel(diagdict, ref = "IS")=IS</th><th>921</th><th>145</th><th>   169.2</th><th>     3.47</th><th>     38.6</th></tr> 
<tr><th style="text-align:left;">relevel(diagdict, ref = "IS")=ICH</th><th>110</th><th>41</th><th>    16.8</th><th>    35.06</th><th>     38.6</th></tr> 
</table>
<br>
&emsp; Chisq= 38.6  on 1 degrees of freedom, p= 5e-10 
</div>

<h2>Kaplan-Meier plot</h2>
<p>Overlevelsesanalyser kan illustreres ved hjælp af Kaplan-Meier plots med funktionen <b>survfit</b> fra pakken {survminer}<br><br>Kaplan-meier plot for ovenstående modeller:</p>
<p class="rcode">
library(survminer) <br>
fit1 &lt;-  survfit(<br>
&emsp; &emsp;     Surv(daystillmors, morsdic1y == "Dead") ~ relevel(diagdict, ref="IS"), <br>
&emsp; &emsp; &emsp; &emsp;      data = strokedata)<br>
ggsurvplot(fit1)
</p>
<div class="centerimg">
<img src="https://jacobliljehult.github.io/research/images/kaplanmeier_simple.png"></div>
<p>Problemet med dette plot er at tids- og eventvariablene har forskellige tidsperspektiver: Event-variablen angiver kun dødsfald indenfor det første år, men tidsvariablen angiver tid indtil dødsfald op til fire år efter; med det resultat at alle dødsfald efter 366 dage bortcensoreres. Man kan derfor tilføje argumenter for at styre hvordan plottet skal renderes:</p>
<p class="rcode">
ggsurvplot(fit1,<br>
&emsp; &emsp; &emsp; &emsp;  xlim = c(0,366), &emsp;     # Afgrænser x-aksen til 366 dage<br>
&emsp; &emsp; &emsp; &emsp;  break.time.by = 30, &emsp;  # Opdeler x-aksen i 30 dages intervaller<br>
&emsp; &emsp; &emsp; &emsp;  conf.int = TRUE, &emsp;  # Tilføjer konfidensintervaller<br>
&emsp; &emsp; &emsp; &emsp;  conf.int.style = "step",<br>
&emsp; &emsp; &emsp; &emsp;  palette = c("blue","red"), &emsp;  # Farven på kurverne<br>
&emsp; &emsp; &emsp; &emsp;  ggtheme = theme_bw(), &emsp;  # Figurtemaet<br>
&emsp; &emsp; &emsp; &emsp;  pval = "Log-rank: P &lt;0.001", pval.coord = c(30,0.03), pval.size = 3.5,<br>
&emsp; &emsp; &emsp; &emsp;  censor.shape= "|", &emsp;  # Angivelse af censur på kurven<br>
&emsp; &emsp; &emsp; &emsp;  title = "Overlevelse efter apopleksi",<br>
&emsp; &emsp; &emsp; &emsp;  ylab = "Overlevelse", xlab = "Antal dage",<br>
&emsp; &emsp; &emsp; &emsp;  legend = c(0.2, 0.2), &emsp;  # Placeringen af forklaringen inde i figuren<br>
&emsp; &emsp; &emsp; &emsp;  legend.title = "Apopleksi type:", &emsp;  # Titel på forklaringen<br>
&emsp; &emsp; &emsp; &emsp;  legend.labs = c("Iskæmisk", "Hæmorrhagisk"), &emsp;  # Labels på forklaringen<br>
&emsp; &emsp; &emsp; &emsp;  ) 
</p>
<div class="centerimg">
<img src="https://jacobliljehult.github.io/research/images/kaplanmeier_advanced.png"></div>
